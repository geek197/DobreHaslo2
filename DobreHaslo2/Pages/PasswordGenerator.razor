@page "/"
@using System.Numerics
@inject IJSRuntime JS

<PageTitle>Generator hase≥</PageTitle>

<div style="margin:10px">

<h1>Generator hase≥</h1>

<p>Wybierz parametry i generuj has≥a ó postÍp zbierania entropii nie jest wymagany.</p>

<div class="row">
    <div class="col-12 col-lg-8">
        <div class="mb-3">
            <label>Liczba hase≥ (1-1000)</label>
            <input type="number" class="form-control" min="1" max="1000" @bind="Count" />
        </div>

        <div class="mb-3">
            <label>D≥ugoúÊ has≥a (1-1000)</label>
            <input type="number" class="form-control" min="1" max="1000" @bind="Length" />
        </div>

        <div class="mb-3">
            <label>Zestawy znakÛw</label>
            <div>
                @foreach (var set in CharSets)
                {
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="@set.Key" checked="@set.Value.Selected" @onchange="(()=>ToggleSet(set.Key))" />
                        <label class="form-check-label" for="@set.Key">@set.Value.Display</label>
                    </div>
                }
            </div>
        </div>

        <div class="mb-3">
            <label>W≥asne znaki (dodatkowe)</label>
            <input class="form-control" @bind="CustomChars" />
        </div>

        <div class="mb-3">
            <div class="mb-3">
                <button class="btn btn-primary" @onclick="GenerateNow">Generuj nowe has≥a</button>
                <button class="btn btn-secondary ms-2" @onclick="CopyToClipboard" disabled="@(string.IsNullOrEmpty(GeneratedText))">Kopiuj do schowka</button>
            </div>
        </div>

        <h4>Wygenerowane has≥a</h4>
        <textarea class="form-control" style="height:300px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', 'Courier New', monospace;" readonly>@GeneratedText</textarea>
    </div>

    <div class="col-12 col-lg-4">
        <h4 class="mt-3">Informacje</h4>
        <ul>
            <li>Z≥oøonoúÊ (bity): @BitsPerPasswordFormatted</li>
            <li>Liczba kombinacji: @CombinationsDisplay</li>
            <li>Czas sprawdzenia przy @CombinationsPerSecondDisplay kombinacjach/s: @CheckTimeDisplay</li>
        </ul>
    </div>
</div>

@if (ShowToast)
{
    <div class="alert alert-success position-fixed" style="right:10px; bottom:10px; z-index:2000;">Has≥a skopiowane do schowka!</div>
}

</div>

@code {
    private int _count = 10;
    private int _length = 16;
    private string _customChars = string.Empty;

    private int Count
    {
        get => _count;
        set
        {
            _count = Math.Clamp(value, 1, 1000);
            UpdateDerivedAndMaybeGenerate();
        }
    }

    private int Length
    {
        get => _length;
        set
        {
            _length = Math.Clamp(value, 1, 1000);
            UpdateDerivedAndMaybeGenerate();
        }
    }

    private string CustomChars
    {
        get => _customChars;
        set
        {
            _customChars = value ?? string.Empty;
            UpdateDerivedAndMaybeGenerate();
        }
    }

    private Dictionary<string, (string Display, string Chars, bool Selected)> CharSets = new();

    private string GeneratedText = string.Empty;

    private double BitsPerPassword = 0;
    private string BitsPerPasswordFormatted => BitsPerPassword.ToString("F2", System.Globalization.CultureInfo.InvariantCulture);
    private string CombinationsDisplay = "-";
    private double CombinationsPerSecond = 1_000_000;
    private string CombinationsPerSecondDisplay = "1 000 000";
    private string CheckTimeDisplay = "-";

    private bool ShowToast = false;

    // generation coalescing
    private bool _isGenerating = false;
    private bool _needsGenerate = false;

    protected override Task OnInitializedAsync()
    {
        CharSets = new Dictionary<string, (string, string, bool)>
        {
            ["lower_en"] = ("Ma≥e litery (ang.)","abcdefghijklmnopqrstuvwxyz", true),
            ["upper_en"] = ("Duøe litery (ang.)","ABCDEFGHIJKLMNOPQRSTUVWXYZ", true),
            ["lower_pl"] = ("Ma≥e litery (pol.)","πÊÍ≥ÒÛúøü", false),
            ["upper_pl"] = ("Duøe litery (pol.)","•∆ £—”åØè", false),
            ["special"] = ("Znaki specjalne","!\"#$%&'()*+,-./:;<=>?@[\\]^_`{|}~", false),
            ["binary"] = ("Binarne","01", false),
            ["decimal"] = ("Cyfry","0123456789", true),
            ["hex_lower"] = ("Szesnastkowe (ma≥e)","0123456789abcdef", false)
        };

        UpdateDerived();
        // generate initial passwords
        _ = GenerateNow();
        return Task.CompletedTask;
    }

    private void ToggleSet(string key)
    {
        var v = CharSets[key];
        CharSets[key] = (v.Display, v.Chars, !v.Selected);
        UpdateDerivedAndMaybeGenerate();
    }

    private void UpdateDerivedAndMaybeGenerate()
    {
        UpdateDerived();
        if (_isGenerating)
        {
            _needsGenerate = true;
        }
        else
        {
            _ = GenerateNow();
        }
    }

    private void UpdateDerived()
    {
        var charset = BuildCharset();
        var k = charset.Length;
        if (k == 0 || Length <= 0)
        {
            BitsPerPassword = 0;
            CombinationsDisplay = "0";
            CheckTimeDisplay = "-";
            GeneratedText = string.Empty;
            return;
        }

        BitsPerPassword = Math.Log(k, 2) * Length;

        var log10Combos = Length * Math.Log10(k);
        if (log10Combos <= 18)
        {
            var combos = BigInteger.Pow(new BigInteger(k), Length);
            CombinationsDisplay = combos.ToString("N0");
        }
        else
        {
            CombinationsDisplay = FormatPolishScale(log10Combos);
        }

        var secondsLog10 = log10Combos - Math.Log10(CombinationsPerSecond);
        CheckTimeDisplay = FormatTimeFromLog10Polish(secondsLog10);

        if (string.IsNullOrEmpty(GeneratedText))
        {
            // nothing
        }
    }

    private string FormatPolishScale(double log10Combos)
    {
        var scales = new (double Log10Div, string Label)[ ]
        {
            (12, "biliony"),
            (9, "miliardy"),
            (6, "miliony"),
            (3, "tysiπce")
        };

        foreach (var s in scales)
        {
            if (log10Combos >= s.Log10Div)
            {
                var scaledLog10 = log10Combos - s.Log10Div;
                var scaled = Math.Pow(10.0, scaledLog10);
                return $"{scaled:F2} {s.Label}";
            }
        }

        var combos = BigInteger.Pow(new BigInteger((int)Math.Round(Math.Pow(10, Math.Floor(Math.Min(log10Combos, 18))))), 1);
        return combos.ToString("N0");
    }

    private string FormatTimeFromLog10Polish(double secondsLog10)
    {
        if (double.IsNaN(secondsLog10) || double.IsInfinity(secondsLog10)) return "-";
        if (secondsLog10 < 0) return "< 1 s";

        var seconds = Math.Pow(10.0, secondsLog10);
        var years = seconds / 31557600.0;
        if (years < 1)
        {
            return FormatTimeFromLog10(secondsLog10);
        }

        if (years >= 1e12) return $"~{(years/1e12):F2} bilionÛw lat";
        if (years >= 1e9) return $"~{(years/1e9):F2} miliardÛw lat";
        if (years >= 1e6) return $"~{(years/1e6):F2} milionÛw lat";
        if (years >= 1e3) return $"~{(years/1e3):F2} tysiÍcy lat";
        return $"~{years:F2} lat";
    }

    private string FormatTimeFromLog10(double secondsLog10)
    {
        if (double.IsNaN(secondsLog10) || double.IsInfinity(secondsLog10)) return "-";
        if (secondsLog10 < 0) return "< 1 s";

        var units = new (string Label, double Log10Seconds)[]
        {
            ("lat", Math.Log10(31557600.0)),
            ("dni", Math.Log10(86400.0)),
            ("h", Math.Log10(3600.0)),
            ("min", Math.Log10(60.0)),
            ("s", Math.Log10(1.0))
        };

        foreach (var u in units)
        {
            var valueLog10 = secondsLog10 - u.Log10Seconds;
            if (valueLog10 < 6)
            {
                var value = Math.Pow(10.0, valueLog10);
                if (value < 1) return "< 1 " + u.Label;
                return $"{value:F2} {u.Label}";
            }
        }

        var yearsLog10 = secondsLog10 - Math.Log10(31557600.0);
        var exponent = Math.Floor(yearsLog10);
        var mantissa = Math.Pow(10.0, yearsLog10 - exponent);
        return $"~{mantissa:F3}e{(long)exponent} lat";
    }

    private async Task GenerateNow()
    {
        if (_isGenerating)
        {
            _needsGenerate = true;
            return;
        }

        var charset = BuildCharset();
        if (string.IsNullOrEmpty(charset) || Length <= 0) return;

        _isGenerating = true;
        _needsGenerate = false;
        try
        {
            var totalChars = Count * Length;
            var bytes = new byte[totalChars];
            using (var rng = System.Security.Cryptography.RandomNumberGenerator.Create())
            {
                rng.GetBytes(bytes);
            }

            var sb = new System.Text.StringBuilder();
            var idx = 0;
            for (int i = 0; i < Count; i++)
            {
                for (int j = 0; j < Length; j++)
                {
                    var v = bytes[idx] % (byte)charset.Length;
                    sb.Append(charset[v]);
                    idx++;
                }
                sb.AppendLine();
            }

            GeneratedText = sb.ToString();
            await InvokeAsync(StateHasChanged);
        }
        catch
        {
            GeneratedText = string.Empty;
        }
        finally
        {
            _isGenerating = false;
            if (_needsGenerate)
            {
                _ = GenerateNow();
            }
        }
    }

    private async Task CopyToClipboard()
    {
        if (string.IsNullOrEmpty(GeneratedText)) return;
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", GeneratedText);
        ShowToast = true;
        await InvokeAsync(StateHasChanged);
        _ = Task.Run(async () =>
        {
            await Task.Delay(3000);
            ShowToast = false;
            await InvokeAsync(StateHasChanged);
        });
    }

    private string BuildCharset()
    {
        var sb = new System.Text.StringBuilder();
        foreach (var kv in CharSets)
        {
            if (kv.Value.Selected) sb.Append(kv.Value.Chars);
        }
        if (!string.IsNullOrEmpty(CustomChars)) sb.Append(CustomChars);
        return new string(sb.ToString().ToCharArray().Distinct().ToArray());
    }
}
